<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALEX Brain Viewer - Live Transparenz</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .brain-container {
            max-width: 1200px;
            margin: 0 auto;
            background: #161b22;
            border-radius: 12px;
            padding: 30px;
            border: 1px solid #30363d;
        }
        
        .brain-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #21262d;
        }
        
        .brain-title {
            font-size: 2rem;
            color: #58a6ff;
            margin: 0;
        }
        
        .brain-status {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .status-item {
            background: #21262d;
            padding: 10px 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .status-value {
            display: block;
            font-size: 1.5rem;
            font-weight: bold;
            color: #7ee787;
        }
        
        .status-label {
            font-size: 0.9rem;
            color: #8b949e;
        }
        
        .activity-section {
            background: #0d1117;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #30363d;
        }
        
        .thinking-indicator {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .neural-activity {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .neuron {
            width: 12px;
            height: 12px;
            background: #58a6ff;
            border-radius: 50%;
            opacity: 0.3;
            transition: all 0.3s ease;
        }
        
        .neuron.active {
            opacity: 1;
            animation: pulse 1s infinite;
            box-shadow: 0 0 10px #58a6ff;
        }
        
        .thinking-text {
            font-size: 1.1rem;
            color: #58a6ff;
            font-weight: bold;
        }
        
        .thinking-text.processing {
            color: #f85149;
            animation: pulse 1s infinite;
        }
        
        .activity-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            display: block;
            font-size: 1.4rem;
            color: #7ee787;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #8b949e;
        }
        
        .brain-section {
            margin-bottom: 30px;
            background: #0d1117;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #58a6ff;
        }
        
        .section-title {
            font-size: 1.3rem;
            color: #58a6ff;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-content {
            background: #161b22;
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            border: 1px solid #30363d;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .extensions-list {
            display: grid;
            gap: 10px;
        }
        
        .extension-item {
            background: #21262d;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #7ee787;
        }
        
        .extension-content {
            font-weight: bold;
            color: #f0f6fc;
            margin-bottom: 5px;
        }
        
        .extension-meta {
            font-size: 0.8rem;
            color: #8b949e;
        }
        
        .activity-feed {
            background: linear-gradient(135deg, #161b22 0%, #0d1117 100%);
            border-radius: 12px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            border: 1px solid #30363d;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
        }

        .activity-feed::-webkit-scrollbar {
            width: 8px;
        }

        .activity-feed::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }

        .activity-feed::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #58a6ff, #1f6feb);
            border-radius: 4px;
        }

        .empty-state {
            text-align: center;
            color: #8b949e;
            font-style: italic;
            padding: 40px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: #58a6ff;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* ===== CONVERSATION GROUP STYLING ===== */
        .conversation-group {
            background: rgba(22, 27, 34, 0.8);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #30363d;
            position: relative;
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
        }

        .conversation-group:hover {
            border-color: #58a6ff;
            box-shadow: 0 0 20px rgba(88, 166, 255, 0.1);
            transform: translateY(-1px);
        }

        .conversation-header {
            margin-bottom: 12px;
        }

        .conversation-timing {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #8b949e;
        }

        .start-time, .end-time {
            font-weight: 600;
            color: #c9d1d9;
        }

        .processing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
            border-radius: 16px;
            background: rgba(13, 17, 23, 0.8);
            border: 1px solid #30363d;
        }

        .processing-indicator.fast {
            border-color: #238636;
            background: rgba(35, 134, 54, 0.1);
        }

        .processing-indicator.medium {
            border-color: #d29922;
            background: rgba(210, 153, 34, 0.1);
        }

        .processing-indicator.slow {
            border-color: #da3633;
            background: rgba(218, 54, 51, 0.1);
        }

        .processing-dots {
            display: flex;
            gap: 2px;
        }

        .processing-dots span {
            width: 4px;
            height: 4px;
            background: #58a6ff;
            border-radius: 50%;
            animation: processingPulse 1.5s infinite;
        }

        .processing-dots span:nth-child(2) { animation-delay: 0.3s; }
        .processing-dots span:nth-child(3) { animation-delay: 0.6s; }

        .processing-time {
            font-weight: 600;
            color: #c9d1d9;
        }

        /* ===== MESSAGE BUBBLES ===== */
        .conversation-flow {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 16px 0;
        }

        .message-bubble {
            flex: 1;
            background: rgba(13, 17, 23, 0.6);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid #30363d;
            backdrop-filter: blur(4px);
        }

        .user-bubble {
            border-left: 3px solid #1f6feb;
            background: linear-gradient(135deg, rgba(31, 111, 235, 0.1), rgba(13, 17, 23, 0.6));
        }

        .alex-bubble {
            border-left: 3px solid #238636;
            background: linear-gradient(135deg, rgba(35, 134, 54, 0.1), rgba(13, 17, 23, 0.6));
        }

        .bubble-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.75rem;
        }

        .bubble-icon {
            font-size: 1rem;
        }

        .bubble-label {
            font-weight: 600;
            color: #c9d1d9;
        }

        .message-length {
            color: #8b949e;
            background: rgba(255,255,255,0.05);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .bubble-content {
            color: #c9d1d9;
            font-size: 0.85rem;
            line-height: 1.4;
            word-break: break-word;
        }

        /* ===== FLOW ARROW ===== */
        .flow-arrow {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
            position: relative;
        }

        .arrow-line {
            width: 30px;
            height: 2px;
            background: linear-gradient(90deg, #30363d, #58a6ff, #30363d);
            position: relative;
            animation: flowPulse 2s infinite;
        }

        .flow-arrow.fast .arrow-line {
            background: linear-gradient(90deg, #238636, #7ee787, #238636);
            animation-duration: 1s;
        }

        .flow-arrow.slow .arrow-line {
            background: linear-gradient(90deg, #da3633, #f85149, #da3633);
            animation-duration: 3s;
        }

        .arrow-head {
            color: #58a6ff;
            font-size: 0.8rem;
            margin-top: 2px;
        }

        .flow-timing {
            font-size: 0.7rem;
            color: #8b949e;
            margin-top: 4px;
            font-weight: 600;
        }

        /* ===== PERFORMANCE FOOTER ===== */
        .conversation-footer {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #21262d;
        }

        .performance-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.75rem;
        }

        .perf-label {
            color: #8b949e;
            font-weight: 600;
        }

        .perf-bar {
            flex: 1;
            height: 6px;
            background: #21262d;
            border-radius: 3px;
            overflow: hidden;
        }

        .perf-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .perf-fill.fast {
            background: linear-gradient(90deg, #238636, #7ee787);
        }

        .perf-fill.medium {
            background: linear-gradient(90deg, #d29922, #f2cc60);
        }

        .perf-fill.slow {
            background: linear-gradient(90deg, #da3633, #f85149);
        }

        .perf-text {
            font-weight: 600;
            min-width: 80px;
        }

        .perf-text.fast { color: #7ee787; }
        .perf-text.medium { color: #f2cc60; }
        .perf-text.slow { color: #f85149; }

        /* ===== ACTIVE REQUEST STYLING ===== */
        .active-request-indicator {
            background: linear-gradient(135deg, rgba(248, 81, 73, 0.15), rgba(13, 17, 23, 0.8));
            border: 2px solid #f85149;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            animation: activeRequestPulse 2s infinite;
        }

        .thinking-animation {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .thinking-dots {
            display: flex;
            gap: 4px;
        }

        .thinking-dots span {
            width: 8px;
            height: 8px;
            background: #f85149;
            border-radius: 50%;
            animation: thinkingBounce 1.4s infinite;
        }

        .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
        .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

        .thinking-text {
            color: #f85149;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .active-request-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .request-time {
            color: #8b949e;
            font-weight: 600;
        }

        .request-message {
            color: #c9d1d9;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ===== SINGLE ACTIVITY STYLING ===== */
        .single-activity {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #30363d;
            background: rgba(22, 27, 34, 0.4);
            transition: all 0.3s ease;
        }

        .single-activity:hover {
            background: rgba(22, 27, 34, 0.8);
            transform: translateX(4px);
        }

        .single-activity.error {
            border-left-color: #da3633;
            background: linear-gradient(135deg, rgba(218, 54, 51, 0.1), rgba(22, 27, 34, 0.4));
        }

        .single-activity.token {
            border-left-color: #d29922;
            background: linear-gradient(135deg, rgba(210, 153, 34, 0.1), rgba(22, 27, 34, 0.4));
        }

        .single-activity.system {
            border-left-color: #8b949e;
            background: linear-gradient(135deg, rgba(139, 148, 158, 0.1), rgba(22, 27, 34, 0.4));
        }

        .activity-icon {
            font-size: 1.2rem;
            min-width: 24px;
            text-align: center;
        }

        .activity-details {
            flex: 1;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .activity-label {
            font-weight: 600;
            color: #c9d1d9;
            font-size: 0.8rem;
        }

        .activity-time {
            color: #8b949e;
            font-size: 0.75rem;
        }

        .activity-message {
            color: #8b949e;
            font-size: 0.75rem;
            line-height: 1.3;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes processingPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        @keyframes flowPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        @keyframes activeRequestPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(248, 81, 73, 0.3); }
            50% { box-shadow: 0 0 0 8px rgba(248, 81, 73, 0); }
        }

        @keyframes thinkingBounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .conversation-flow {
                flex-direction: column;
                gap: 8px;
            }

            .flow-arrow {
                transform: rotate(90deg);
                min-width: auto;
                min-height: 30px;
            }

            .conversation-timing {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }

            .performance-indicator {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }

            .active-request-details {
                flex-direction: column;
                gap: 4px;
                text-align: center;
            }
        }

        .update-info {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #1f6feb;
            border-radius: 8px;
            color: white;
        }
        
        .refresh-btn {
            background: #238636;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            margin: 10px;
        }
        
        .refresh-btn:hover {
            background: #2ea043;
        }
        
        .loading {
            text-align: center;
            color: #58a6ff;
            font-style: italic;
        }
        
        .error {
            background: #da3633;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .updating {
            animation: pulse 1s infinite;
        }
        
        @media (max-width: 768px) {
            .brain-status {
                flex-direction: column;
            }

            .activity-stats {
                flex-direction: column;
            }

            .refresh-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="brain-container">
        <div class="brain-header">
            <h1 class="brain-title">🧠 ALEX Brain Viewer</h1>
            <p>Live Transparenz-Dashboard - Sieh wie ALEX denkt</p>
            
            <div class="brain-status" id="brainStatus">
                <div class="status-item">
                    <span class="status-value" id="extensionsCount">0</span>
                    <span class="status-label">Erweiterungen</span>
                </div>
                <div class="status-item">
                    <span class="status-value" id="promptLength">0</span>
                    <span class="status-label">Prompt Zeichen</span>
                </div>
                <div class="status-item">
                    <span class="status-value" id="lastUpdate">--:--</span>
                    <span class="status-label">Letztes Update</span>
                </div>
            </div>
            
            <div class="activity-section">
                <div class="thinking-indicator" id="thinkingIndicator">
                    <div class="neural-activity">
                        <div class="neuron" id="neuron1"></div>
                        <div class="neuron" id="neuron2"></div>
                        <div class="neuron" id="neuron3"></div>
                    </div>
                    <div class="thinking-text" id="thinkingText">
                        🧠 ALEX ist bereit...
                    </div>
                </div>
                
                <div class="activity-stats" id="activityStats">
                    <div class="stat-item">
                        <span class="stat-value" id="totalRequests">0</span>
                        <span class="stat-label">Anfragen gesamt</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="activeRequests">0</span>
                        <span class="stat-label">Aktiv denkend</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="avgResponseTime">0ms</span>
                        <span class="stat-label">⌀ Antwortzeit</span>
                    </div>
                </div>
            </div>
            
            <button class="refresh-btn" onclick="loadBrainState()">🔄 Aktualisieren</button>
            <button class="refresh-btn" onclick="toggleAutoRefresh(this)">⏱️ Auto-Refresh</button>
        </div>

        <div class="brain-section">
            <h2 class="section-title">⚡ Live Activity Feed</h2>
            <div id="activityFeed" class="activity-feed">
                <div class="empty-state">Warte auf Aktivität...</div>
            </div>
        </div>

        <div id="loadingState" class="loading">
            Lade ALEX Gehirn-Status...
        </div>

        <div id="errorState" class="error" style="display: none;">
            Fehler beim Laden der Brain-Daten
        </div>

        <div id="brainContent" style="display: none;">
            <div class="brain-section">
                <h2 class="section-title">📋 Grundpersönlichkeit</h2>
                <div class="section-content" id="basePersonality">
                </div>
            </div>

            <div class="brain-section">
                <h2 class="section-title">🔧 Aktive Erweiterungen (<span id="extensionsCountText">0</span>)</h2>
                <div id="extensionsContent">
                </div>
            </div>

            <div class="brain-section">
                <h2 class="section-title">👁️ Kompletter System-Prompt</h2>
                <div class="section-content" id="fullPrompt">
                </div>
            </div>
        </div>

        <div class="update-info">
            <strong>Live-Dashboard:</strong> Zeigt den aktuellen "Gedanken-Zustand" von ALEX.<br>
            Jede Token-Einlösung ändert sofort die Instructions!
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let isAutoRefresh = false;
        let eventSource = null;

        async function loadBrainState() {
            const loadingEl = document.getElementById('loadingState');
            const errorEl = document.getElementById('errorState');
            const contentEl = document.getElementById('brainContent');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            contentEl.style.display = 'none';

            try {
                const response = await fetch('/api/alex-brain');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'API Error');
                }

                document.getElementById('extensionsCount').textContent = data.extensionsCount;
                document.getElementById('promptLength').textContent = data.systemPromptLength;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

                document.getElementById('basePersonality').textContent = data.basePersonality;

                updateExtensions(data.extensions);

                const fullPrompt = `${data.basePersonality}\n\n${data.extensionsText}`;
                document.getElementById('fullPrompt').textContent = fullPrompt;

                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
            } catch (error) {
                console.error('Brain load error:', error);
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = 'Fehler: ' + error.message;
            }
        }

        function updateExtensions(extensions) {
            const container = document.getElementById('extensionsContent');
            const countEl = document.getElementById('extensionsCountText');

            countEl.textContent = extensions.length;

            if (!extensions.length) {
                container.innerHTML = '<div class="empty-state">Noch keine Erweiterungen von Teilnehmern</div>';
                return;
            }

            container.innerHTML = `
                <div class="extensions-list">
                    ${extensions.map(ext => `
                        <div class="extension-item">
                            <div class="extension-content">${ext.content}</div>
                            <div class="extension-meta">
                                Von: ${ext.winner} | Token: ${ext.token || '–'} |
                                ${ext.timestamp ? new Date(ext.timestamp).toLocaleString('de-DE') : 'Zeit unbekannt'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function toggleAutoRefresh(button) {
            if (isAutoRefresh) {
                clearInterval(autoRefreshInterval);
                isAutoRefresh = false;
                button.textContent = '⏱️ Auto-Refresh';
                button.style.background = '#238636';
            } else {
                autoRefreshInterval = setInterval(loadBrainState, 3000);
                isAutoRefresh = true;
                button.textContent = '⏹️ Stop Auto';
                button.style.background = '#da3633';
            }
        }

        function initLiveActivity() {
            if (typeof EventSource !== 'undefined') {
                eventSource = new EventSource('/api/alex-activity');

                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        updateActivityDisplay(data);
                    } catch (error) {
                        console.error('Activity parse error:', error);
                    }
                };

                eventSource.onerror = (error) => {
                    console.error('EventSource failed:', error);
                    eventSource.close();
                    eventSource = null;
                    setTimeout(pollActivity, 3000);
                };
            } else {
                setInterval(pollActivity, 3000);
            }
        }

        async function pollActivity() {
            try {
                const response = await fetch('/api/alex-activity');
                const data = await response.json();
                updateActivityDisplay(data);
            } catch (error) {
                console.error('Activity polling failed:', error);
            }
        }

        function updateActivityDisplay(data) {
            if (!data || data.error) {
                console.warn('No activity data available');
                return;
            }

            const thinkingText = document.getElementById('thinkingText');
            const neurons = document.querySelectorAll('.neuron');

            if (data.isProcessing && data.activeRequests > 0) {
                thinkingText.textContent = `🔥 ALEX denkt gerade... (${data.activeRequests} aktiv)`;
                thinkingText.className = 'thinking-text processing';

                neurons.forEach((neuron, index) => {
                    setTimeout(() => {
                        neuron.classList.add('active');
                    }, index * 200);
                });
            } else {
                thinkingText.textContent = '🧠 ALEX ist bereit...';
                thinkingText.className = 'thinking-text';

                neurons.forEach(neuron => {
                    neuron.classList.remove('active');
                });
            }

            if (data.stats) {
                document.getElementById('totalRequests').textContent = data.stats.totalRequests || 0;
                document.getElementById('activeRequests').textContent = data.activeRequests || 0;
                document.getElementById('avgResponseTime').textContent = `${data.stats.avgResponseTime || 0}ms`;
            }

            updateActivityFeed(data.recentActivities || []);
        }

        function updateActivityFeed(activities) {
            const feed = document.getElementById('activityFeed');

            if (!activities || activities.length === 0) {
                feed.innerHTML = `
                    <div class="empty-state">
                        <div class="pulse-dot"></div>
                        <span>Warte auf ALEX Aktivität...</span>
                    </div>
                `;
                return;
            }

            // Gruppiere Request/Response Paare
            const groupedActivities = groupRequestResponse(activities);

            feed.innerHTML = groupedActivities.map(group => {
                if (group.type === 'conversation') {
                    return renderConversation(group);
                } else {
                    return renderSingleActivity(group);
                }
            }).join('');
        }

        function groupRequestResponse(activities) {
            const grouped = [];
            const processed = new Set();

            console.log('🔍 DEBUG: Grouping activities:', activities.length);

            const sortedActivities = activities
                .slice()
                .sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());

            sortedActivities.forEach(activity => {
                if (processed.has(activity.id)) return;

                console.log('🔍 Processing activity:', {
                    type: activity.type,
                    requestId: activity.requestId?.substring(0, 15),
                    message: activity.data?.message?.substring(0, 30)
                });

                if (activity.type === 'request_start') {
                    const matchingResponse = sortedActivities.find(resp =>
                        resp.type === 'request_end' &&
                        !processed.has(resp.id) &&
                        (
                            (activity.requestId && resp.requestId && resp.requestId === activity.requestId) ||
                            (!activity.requestId && !resp.requestId && resp.sessionId === activity.sessionId)
                        )
                    );

                    if (matchingResponse) {
                        console.log('✅ Found matching pair:', {
                            requestId: activity.requestId?.substring(0, 15),
                            request: activity.data?.message?.substring(0, 30),
                            response: matchingResponse.data?.response?.substring(0, 30)
                        });

                        grouped.push({
                            type: 'conversation',
                            request: activity,
                            response: matchingResponse,
                            responseTime:
                                matchingResponse.data?.processingTime ||
                                calculateResponseTime(activity.timestamp, matchingResponse.timestamp)
                        });

                        processed.add(activity.id);
                        processed.add(matchingResponse.id);
                    } else {
                        console.log('⏳ Active request (no response yet):', {
                            requestId: activity.requestId?.substring(0, 15),
                            message: activity.data?.message?.substring(0, 30)
                        });

                        grouped.push({
                            type: 'active_request',
                            activity: activity
                        });
                        processed.add(activity.id);
                    }
                } else if (activity.type === 'request_error') {
                    grouped.push({
                        type: 'single',
                        activity: activity
                    });
                    processed.add(activity.id);
                } else if (!processed.has(activity.id)) {
                    grouped.push({
                        type: 'single',
                        activity: activity
                    });
                    processed.add(activity.id);
                }
            });

            console.log('🔍 Grouping result:', {
                totalActivities: activities.length,
                groupedItems: grouped.length,
                conversations: grouped.filter(g => g.type === 'conversation').length,
                activeRequests: grouped.filter(g => g.type === 'active_request').length
            });

            return grouped;
        }

        function renderConversation(group) {
            const requestTime = new Date(group.request.timestamp).toLocaleTimeString('de-DE');
            const responseTime = new Date(group.response.timestamp).toLocaleTimeString('de-DE');
            const processingTime = Number.isFinite(group.responseTime) ? group.responseTime : 0;

            const requestMessage = group.request.data?.message || 'Unbekannte Anfrage';
            const responseMessage = group.response.data?.response || 'Unbekannte Antwort';
            const responsePreview = responseMessage.substring(0, 80) + (responseMessage.length > 80 ? '...' : '');

            const speedClass = processingTime < 2000 ? 'fast' : processingTime < 5000 ? 'medium' : 'slow';
            const debugInfo = window.location.hostname === 'localhost' ? `
                <div style="font-size: 0.7rem; color: #666; margin-top: 4px; font-family: monospace;">
                    Debug: Request-ID ${group.request.requestId?.substring(0, 15) || 'missing'} |
                    Session ${group.request.sessionId?.substring(0, 8) || 'missing'}
                </div>
            ` : '';

            return `
                <div class="conversation-group">
                    <div class="conversation-header">
                        <div class="conversation-timing">
                            <span class="start-time">${requestTime}</span>
                            <div class="processing-indicator ${speedClass}">
                                <div class="processing-dots">
                                    <span></span><span></span><span></span>
                                </div>
                                <span class="processing-time">${processingTime}ms</span>
                            </div>
                            <span class="end-time">${responseTime}</span>
                        </div>
                        ${debugInfo}
                    </div>

                    <div class="conversation-flow">
                        <div class="message-bubble user-bubble">
                            <div class="bubble-header">
                                <span class="bubble-icon">👤</span>
                                <span class="bubble-label">User fragt</span>
                                <span class="message-length">${requestMessage.length} Zeichen</span>
                            </div>
                            <div class="bubble-content">${requestMessage}</div>
                        </div>

                        <div class="flow-arrow ${speedClass}">
                            <div class="arrow-line"></div>
                            <div class="arrow-head">▶</div>
                            <div class="flow-timing">${processingTime}ms</div>
                        </div>

                        <div class="message-bubble alex-bubble">
                            <div class="bubble-header">
                                <span class="bubble-icon">🤖</span>
                                <span class="bubble-label">ALEX antwortet</span>
                                <span class="message-length">${responseMessage.length} Zeichen</span>
                            </div>
                            <div class="bubble-content">${responsePreview}</div>
                        </div>
                    </div>

                    <div class="conversation-footer">
                        <div class="performance-indicator">
                            <span class="perf-label">Performance:</span>
                            <div class="perf-bar">
                                <div class="perf-fill ${speedClass}" style="width: ${Math.min(100, (6000 - processingTime) / 60)}%"></div>
                            </div>
                            <span class="perf-text ${speedClass}">
                                ${speedClass === 'fast' ? '⚡ Blitzschnell' :
                                  speedClass === 'medium' ? '🔄 Normal' : '🐌 Langsam'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSingleActivity(group) {
            const activity = group.activity || group;
            const time = new Date(activity.timestamp).toLocaleTimeString('de-DE');
            let icon, label, colorClass;

            switch(activity.type) {
                case 'request_error':
                    icon = '❌';
                    label = 'Fehler';
                    colorClass = 'error';
                    break;
                case 'token_used':
                    icon = '🎫';
                    label = 'Token eingelöst';
                    colorClass = 'token';
                    break;
                default:
                    icon = '📡';
                    label = 'System-Event';
                    colorClass = 'system';
            }

            if (group.type === 'active_request') {
                return `
                    <div class="active-request-indicator">
                        <div class="thinking-animation">
                            <div class="thinking-dots">
                                <span></span><span></span><span></span>
                            </div>
                            <span class="thinking-text">🔥 ALEX denkt gerade...</span>
                        </div>
                        <div class="active-request-details">
                            <span class="request-time">${time}</span>
                            <span class="request-message">${activity.data?.message || 'Warte auf Antwort...'}</span>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="single-activity ${colorClass}">
                    <div class="activity-icon">${icon}</div>
                    <div class="activity-details">
                        <div class="activity-header">
                            <span class="activity-label">${label}</span>
                            <span class="activity-time">${time}</span>
                        </div>
                        <div class="activity-message">${activity.data?.message || activity.data?.error || 'System-Aktivität'}</div>
                    </div>
                </div>
            `;
        }

        function calculateResponseTime(startTime, endTime) {
            return new Date(endTime).getTime() - new Date(startTime).getTime();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadBrainState();
            initLiveActivity();
        });

        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
