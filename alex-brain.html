<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALEX Brain Viewer - Live Transparenz</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .brain-container {
            max-width: 1200px;
            margin: 0 auto;
            background: #161b22;
            border-radius: 12px;
            padding: 30px;
            border: 1px solid #30363d;
        }
        
        .brain-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #21262d;
        }
        
        .brain-title {
            font-size: 2rem;
            color: #58a6ff;
            margin: 0;
        }
        
        .brain-status {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .status-item {
            background: #21262d;
            padding: 10px 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .status-value {
            display: block;
            font-size: 1.5rem;
            font-weight: bold;
            color: #7ee787;
        }
        
        .status-label {
            font-size: 0.9rem;
            color: #8b949e;
        }
        
        .activity-section {
            background: #0d1117;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #30363d;
        }
        
        .thinking-indicator {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .neural-activity {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .neuron {
            width: 12px;
            height: 12px;
            background: #58a6ff;
            border-radius: 50%;
            opacity: 0.3;
            transition: all 0.3s ease;
        }
        
        .neuron.active {
            opacity: 1;
            animation: pulse 1s infinite;
            box-shadow: 0 0 10px #58a6ff;
        }
        
        .thinking-text {
            font-size: 1.1rem;
            color: #58a6ff;
            font-weight: bold;
        }
        
        .thinking-text.processing {
            color: #f85149;
            animation: pulse 1s infinite;
        }
        
        .activity-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            display: block;
            font-size: 1.4rem;
            color: #7ee787;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #8b949e;
        }
        
        .brain-section {
            margin-bottom: 30px;
            background: #0d1117;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #58a6ff;
        }
        
        .section-title {
            font-size: 1.3rem;
            color: #58a6ff;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-content {
            background: #161b22;
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            border: 1px solid #30363d;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .extensions-list {
            display: grid;
            gap: 10px;
        }
        
        .extension-item {
            background: #21262d;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #7ee787;
        }
        
        .extension-content {
            font-weight: bold;
            color: #f0f6fc;
            margin-bottom: 5px;
        }
        
        .extension-meta {
            font-size: 0.8rem;
            color: #8b949e;
        }
        
        /* ===== TEEN-FRIENDLY ACTIVITY FEED STYLES ===== */
        .activity-feed {
            background: linear-gradient(135deg, #0d1117 0%, #161b22 50%, #0d1117 100%);
            border-radius: 16px;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'SF Pro Display', system-ui, -apple-system, sans-serif;
            border: 1px solid #30363d;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            backdrop-filter: blur(8px);
        }

        .activity-feed::-webkit-scrollbar {
            width: 6px;
        }

        .activity-feed::-webkit-scrollbar-track {
            background: transparent;
        }

        .activity-feed::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #ff6b6b, #4ecdc4);
            border-radius: 6px;
        }

        .empty-state-teen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .waiting-animation {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .bounce-dots {
            display: flex;
            gap: 8px;
        }

        .bounce-dots span {
            width: 12px;
            height: 12px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border-radius: 50%;
            animation: bounce 1.5s infinite;
        }

        .bounce-dots span:nth-child(2) { animation-delay: 0.3s; }
        .bounce-dots span:nth-child(3) { animation-delay: 0.6s; }

        .waiting-text {
            color: #c9d1d9;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* ===== TEEN CONVERSATION CARDS ===== */
        .teen-conversation-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(88, 166, 255, 0.2);
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .teen-conversation-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #f39c12);
            /* animation: shimmer 3s infinite; ENTFERNT */
        }

        .teen-conversation-card:hover {
            transform: translateY(-4px);
            border-color: rgba(88, 166, 255, 0.4);
            box-shadow: 0 12px 40px rgba(0,0,0,0.3);
        }

        .conversation-header-teen {
            margin-bottom: 16px;
        }

        .time-flow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            background: rgba(13, 17, 23, 0.6);
            border-radius: 12px;
            border: 1px solid #30363d;
        }

        .start-time, .end-time {
            font-size: 0.85rem;
            font-weight: 600;
            color: #c9d1d9;
            padding: 4px 8px;
            background: rgba(88, 166, 255, 0.1);
            border-radius: 6px;
        }

        .processing-flow {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .flow-dots {
            display: flex;
            gap: 3px;
        }

        .flow-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: flowPulse 2s infinite; /* Langsamere, subtilere Animation */
        }

        .processing-flow.super-fast .flow-dots span {
            background: #7ee787;
        }

        .processing-flow.fast .flow-dots span {
            background: #58a6ff;
        }

        .processing-flow.normal .flow-dots span {
            background: #f2cc60;
        }

        .processing-flow.slow .flow-dots span {
            background: #f85149;
        }

        .flow-dots span:nth-child(2) { animation-delay: 0.3s; }
        .flow-dots span:nth-child(3) { animation-delay: 0.6s; }

        .processing-badge {
            font-size: 0.8rem;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 8px;
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
            border: 1px solid rgba(88, 166, 255, 0.3);
        }

        /* ===== CHAT BUBBLES ===== */
        .chat-bubbles-container {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 20px 0;
        }

        .message-card {
            flex: 1;
            border-radius: 16px;
            padding: 16px;
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
        }

        .user-message {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(15, 23, 42, 0.8));
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-left: 4px solid #3b82f6;
        }

        .alex-message {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(15, 23, 42, 0.8));
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-left: 4px solid #22c55e;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .avatar {
            font-size: 1.2rem;
        }

        .sender-label {
            font-weight: 700;
            font-size: 0.85rem;
            color: #c9d1d9;
        }

        .char-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            color: #000;
            margin-left: auto;
        }

        .message-content {
            color: #e6edf3;
            font-size: 0.9rem;
            line-height: 1.5;
            word-break: break-word;
        }

        /* ===== FLOW ARROW ===== */
        .message-flow {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
            position: relative;
        }

        .flow-line {
            width: 40px;
            height: 3px;
            border-radius: 2px;
            position: relative;
            overflow: hidden;
        }

        .message-flow.super-fast .flow-line {
            background: linear-gradient(90deg, #7ee787, #56d364);
            /* animation: superFastPulse 0.8s infinite; ENTFERNT */
        }

        .message-flow.fast .flow-line {
            background: linear-gradient(90deg, #58a6ff, #1f6feb);
            /* animation: fastPulse 1.2s infinite; ENTFERNT */
        }

        .message-flow.normal .flow-line {
            background: linear-gradient(90deg, #f2cc60, #d29922);
            /* animation: normalPulse 1.5s infinite; ENTFERNT */
        }

        .message-flow.slow .flow-line {
            background: linear-gradient(90deg, #f85149, #da3633);
            /* animation: slowPulse 2s infinite; ENTFERNT */
        }

        .flow-arrow {
            color: #58a6ff;
            font-size: 1rem;
            margin: 4px 0;
            filter: drop-shadow(0 0 4px rgba(88, 166, 255, 0.5));
        }

        .flow-time {
            font-size: 0.75rem;
            font-weight: 600;
            color: #8b949e;
            background: rgba(13, 17, 23, 0.8);
            padding: 2px 6px;
            border-radius: 6px;
            border: 1px solid #30363d;
        }

        .flow-spark {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            /* animation: sparkle 2s infinite; ENTFERNT */
            opacity: 0.6; /* Statische opacity statt animation */
        }

        /* ===== PERFORMANCE FOOTER ===== */
        .performance-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(48, 54, 61, 0.5);
        }

        .speed-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .speed-bar {
            width: 100px;
            height: 6px;
            background: rgba(48, 54, 61, 0.8);
            border-radius: 3px;
            overflow: hidden;
        }

        .speed-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .speed-indicator.super-fast .speed-fill {
            background: linear-gradient(90deg, #7ee787, #56d364);
        }

        .speed-indicator.fast .speed-fill {
            background: linear-gradient(90deg, #58a6ff, #1f6feb);
        }

        .speed-indicator.normal .speed-fill {
            background: linear-gradient(90deg, #f2cc60, #d29922);
        }

        .speed-indicator.slow .speed-fill {
            background: linear-gradient(90deg, #f85149, #da3633);
        }

        .speed-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #c9d1d9;
        }

        .conversation-stats {
            display: flex;
            gap: 16px;
        }

        .stat-item {
            font-size: 0.75rem;
            color: #8b949e;
            padding: 4px 8px;
            background: rgba(13, 17, 23, 0.6);
            border-radius: 6px;
            border: 1px solid #30363d;
        }

        /* ===== THINKING CARD ===== */
        .thinking-card-teen {
            background: linear-gradient(135deg, rgba(248, 81, 73, 0.2), rgba(15, 23, 42, 0.9));
            border: 2px solid #f85149;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            /* animation: thinkingPulse 2s infinite; ENTFERNT */
            backdrop-filter: blur(8px);
        }

        .thinking-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .thinking-dots-big {
            display: flex;
            gap: 4px;
        }

        .thinking-dots-big span {
            width: 10px;
            height: 10px;
            background: #f85149;
            border-radius: 50%;
            animation: bigBounce 1.4s infinite;
        }

        .thinking-dots-big span:nth-child(2) { animation-delay: 0.2s; }
        .thinking-dots-big span:nth-child(3) { animation-delay: 0.4s; }

        .thinking-text {
            color: #f85149;
            font-weight: 700;
            font-size: 1rem;
        }

        .thinking-timer {
            margin-left: auto;
            color: #8b949e;
            font-size: 0.8rem;
            padding: 4px 8px;
            background: rgba(13, 17, 23, 0.6);
            border-radius: 6px;
        }

        .thinking-question {
            color: #c9d1d9;
            font-style: italic;
            font-size: 0.85rem;
        }

        /* ===== TOKEN & ERROR CARDS ===== */
        .token-card-teen {
            background: linear-gradient(135deg, rgba(210, 153, 34, 0.2), rgba(15, 23, 42, 0.9));
            border: 2px solid #d29922;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            backdrop-filter: blur(8px);
        }

        .token-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .token-icon {
            font-size: 1.2rem;
        }

        .token-text {
            color: #f2cc60;
            font-weight: 700;
            font-size: 1rem;
        }

        .token-time {
            margin-left: auto;
            color: #8b949e;
            font-size: 0.8rem;
        }

        .token-content {
            color: #c9d1d9;
            font-size: 0.9rem;
        }

        .error-card-teen {
            background: linear-gradient(135deg, rgba(218, 54, 51, 0.2), rgba(15, 23, 42, 0.9));
            border: 2px solid #da3633;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            backdrop-filter: blur(8px);
        }

        .error-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .error-icon {
            font-size: 1.2rem;
        }

        .error-text {
            color: #f85149;
            font-weight: 700;
            font-size: 1rem;
        }

        .error-time {
            margin-left: auto;
            color: #8b949e;
            font-size: 0.8rem;
        }

        .error-details {
            color: #c9d1d9;
            font-size: 0.85rem;
        }

        /* ===== FLASH ANIMATION FÜR NEUE AKTIVITÄTEN ===== */
        .activity-flash-container {
            position: relative;
            transition: all 0.3s ease;
        }

        .activity-flash-container.flash-in {
            animation: activityFlash 2s ease-out;
        }

        @keyframes activityFlash {
            0% {
                background: linear-gradient(135deg, rgba(88, 166, 255, 0.3), rgba(126, 231, 135, 0.3));
                box-shadow: 0 0 0 0 rgba(88, 166, 255, 0.8);
                transform: scale(1.02);
            }
            10% {
                background: linear-gradient(135deg, rgba(88, 166, 255, 0.2), rgba(126, 231, 135, 0.2));
                box-shadow: 0 0 0 8px rgba(88, 166, 255, 0.4);
                transform: scale(1.01);
            }
            20% {
                background: linear-gradient(135deg, rgba(88, 166, 255, 0.1), rgba(126, 231, 135, 0.1));
                box-shadow: 0 0 0 16px rgba(88, 166, 255, 0.2);
                transform: scale(1);
            }
            40% {
                background: linear-gradient(135deg, rgba(88, 166, 255, 0.05), rgba(126, 231, 135, 0.05));
                box-shadow: 0 0 0 24px rgba(88, 166, 255, 0.1);
            }
            100% {
                background: transparent;
                box-shadow: 0 0 0 32px rgba(88, 166, 255, 0);
            }
        }

        .activity-flash-container[data-new="true"] .teen-conversation-card {
            border-color: rgba(88, 166, 255, 0.6);
        }

        .activity-flash-container[data-new="true"] .thinking-card-teen {
            border-color: rgba(248, 81, 73, 0.8);
        }

        .activity-flash-container[data-new="true"] .token-card-teen {
            border-color: rgba(210, 153, 34, 0.8);
        }

        .activity-flash-container[data-new="true"] .error-card-teen {
            border-color: rgba(218, 54, 51, 0.8);
        }

        /* ===== ANIMATIONS ===== */
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); } /* Kleinerer bounce */
        }

        @keyframes flowPulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.8; } /* Weniger intensiv */
        }

        @keyframes bigBounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); } /* Kleinerer bounce */
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .chat-bubbles-container {
                flex-direction: column;
                gap: 12px;
            }

            .message-flow {
                transform: rotate(90deg);
                min-width: auto;
                min-height: 40px;
            }

            .performance-footer {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }

            .conversation-stats {
                justify-content: center;
            }
        }

        .empty-state {
            text-align: center;
            color: #8b949e;
            font-style: italic;
            padding: 40px 20px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .update-info {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #1f6feb;
            border-radius: 8px;
            color: white;
        }
        
        .refresh-btn {
            background: #238636;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            margin: 10px;
        }
        
        .refresh-btn:hover {
            background: #2ea043;
        }
        
        .loading {
            text-align: center;
            color: #58a6ff;
            font-style: italic;
        }
        
        .error {
            background: #da3633;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .updating {
            animation: pulse 1s infinite;
        }
        
        @media (max-width: 768px) {
            .brain-status {
                flex-direction: column;
            }

            .activity-stats {
                flex-direction: column;
            }

            .refresh-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="brain-container">
        <div class="brain-header">
            <h1 class="brain-title">🧠 ALEX Brain Viewer</h1>
            <p>Live Transparenz-Dashboard - Sieh wie ALEX denkt</p>
            
            <div class="brain-status" id="brainStatus">
                <div class="status-item">
                    <span class="status-value" id="extensionsCount">0</span>
                    <span class="status-label">Erweiterungen</span>
                </div>
                <div class="status-item">
                    <span class="status-value" id="promptLength">0</span>
                    <span class="status-label">Prompt Zeichen</span>
                </div>
                <div class="status-item">
                    <span class="status-value" id="lastUpdate">--:--</span>
                    <span class="status-label">Letztes Update</span>
                </div>
            </div>
            
            <div class="activity-section">
                <div class="thinking-indicator" id="thinkingIndicator">
                    <div class="neural-activity">
                        <div class="neuron" id="neuron1"></div>
                        <div class="neuron" id="neuron2"></div>
                        <div class="neuron" id="neuron3"></div>
                    </div>
                    <div class="thinking-text" id="thinkingText">
                        🧠 ALEX ist bereit...
                    </div>
                </div>
                
                <div class="activity-stats" id="activityStats">
                    <div class="stat-item">
                        <span class="stat-value" id="totalRequests">0</span>
                        <span class="stat-label">Anfragen gesamt</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="activeRequests">0</span>
                        <span class="stat-label">Aktiv denkend</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="avgResponseTime">0ms</span>
                        <span class="stat-label">⌀ Antwortzeit</span>
                    </div>
                </div>
            </div>
            
            <button class="refresh-btn" onclick="loadBrainState()">🔄 Aktualisieren</button>
            <button class="refresh-btn" onclick="toggleAutoRefresh(this)">⏱️ Auto-Refresh</button>
        </div>

        <div class="brain-section">
            <h2 class="section-title">⚡ Live Activity Feed</h2>
            <div id="activityFeed" class="activity-feed">
                <div class="empty-state">Warte auf Aktivität...</div>
            </div>
        </div>

        <div id="loadingState" class="loading">
            Lade ALEX Gehirn-Status...
        </div>

        <div id="errorState" class="error" style="display: none;">
            Fehler beim Laden der Brain-Daten
        </div>

        <div id="brainContent" style="display: none;">
            <div class="brain-section">
                <h2 class="section-title">📋 Grundpersönlichkeit</h2>
                <div class="section-content" id="basePersonality">
                </div>
            </div>

            <div class="brain-section">
                <h2 class="section-title">📋 Zusätzliche Anweisungen (<span id="extensionsCountText">0</span>)</h2>
                <div id="extensionsContent">
                </div>
            </div>

            <div class="brain-section">
                <h2 class="section-title">👁️ Kompletter System-Prompt</h2>
                <div class="section-content" id="fullPrompt">
                </div>
            </div>
        </div>

        <div class="update-info">
            <strong>Live-Dashboard:</strong> Zeigt den aktuellen "Gedanken-Zustand" von ALEX.<br>
            Jede Token-Einlösung ändert sofort die Instructions!
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let isAutoRefresh = false;
        let eventSource = null;
        let lastActivityIds = new Set();

        async function loadBrainState() {
            const loadingEl = document.getElementById('loadingState');
            const errorEl = document.getElementById('errorState');
            const contentEl = document.getElementById('brainContent');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            contentEl.style.display = 'none';

            try {
                const response = await fetch('/api/alex-brain');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'API Error');
                }

                document.getElementById('extensionsCount').textContent = data.extensionsCount;
                document.getElementById('promptLength').textContent = data.systemPromptLength;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

                document.getElementById('basePersonality').textContent = data.basePersonality;

                updateExtensions(data.extensions);

                const fullPrompt = `${data.basePersonality}\n\n${data.extensionsText}`;
                document.getElementById('fullPrompt').textContent = fullPrompt;

                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
            } catch (error) {
                console.error('Brain load error:', error);
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = 'Fehler: ' + error.message;
            }
        }

        function updateExtensions(extensions) {
            const container = document.getElementById('extensionsContent');
            const countEl = document.getElementById('extensionsCountText');

            countEl.textContent = extensions.length;

            if (!extensions.length) {
                container.innerHTML = '<div class="empty-state">Noch keine Erweiterungen von Teilnehmern</div>';
                return;
            }

            container.innerHTML = `
                <div class="extensions-list">
                    ${extensions.map(ext => `
                        <div class="extension-item">
                            <div class="extension-content">${ext.content}</div>
                            <div class="extension-meta">
                                Von: ${ext.winner} | Token: ${ext.token || '–'} |
                                ${ext.timestamp ? new Date(ext.timestamp).toLocaleString('de-DE') : 'Zeit unbekannt'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function toggleAutoRefresh(button) {
            if (isAutoRefresh) {
                clearInterval(autoRefreshInterval);
                isAutoRefresh = false;
                button.textContent = '⏱️ Auto-Refresh';
                button.style.background = '#238636';
            } else {
                autoRefreshInterval = setInterval(loadBrainState, 3000);
                isAutoRefresh = true;
                button.textContent = '⏹️ Stop Auto';
                button.style.background = '#da3633';
            }
        }

        function initLiveActivity() {
            if (typeof EventSource !== 'undefined') {
                eventSource = new EventSource('/api/alex-activity');

                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        updateActivityDisplay(data);

                        if (data.recentActivities && data.recentActivities.length > 0) {
                            const latestActivity = data.recentActivities[0];

                            if (latestActivity.type === 'token_used') {
                                console.log('🎫 TOKEN FLASH!');
                            } else if (latestActivity.type === 'request_start') {
                                console.log('📥 NEW QUESTION FLASH!');
                            } else if (latestActivity.type === 'request_end') {
                                console.log('📤 NEW ANSWER FLASH!');
                            }
                        }
                    } catch (error) {
                        console.error('Activity parse error:', error);
                    }
                };

                eventSource.onerror = (error) => {
                    console.error('EventSource failed:', error);
                    eventSource.close();
                    eventSource = null;
                    setTimeout(pollActivity, 3000);
                };
            } else {
                setInterval(pollActivity, 3000);
            }
        }

        async function pollActivity() {
            try {
                const response = await fetch('/api/alex-activity');
                const data = await response.json();
                updateActivityDisplay(data);
            } catch (error) {
                console.error('Activity polling failed:', error);
            }
        }

        function updateActivityDisplay(data) {
            if (!data || data.error) {
                console.warn('No activity data available');
                return;
            }

            const thinkingText = document.getElementById('thinkingText');
            const neurons = document.querySelectorAll('.neuron');

            if (data.isProcessing && data.activeRequests > 0) {
                thinkingText.textContent = `🔥 ALEX denkt gerade... (${data.activeRequests} aktiv)`;
                thinkingText.className = 'thinking-text processing';

                neurons.forEach((neuron, index) => {
                    setTimeout(() => {
                        neuron.classList.add('active');
                    }, index * 200);
                });
            } else {
                thinkingText.textContent = '🧠 ALEX ist bereit...';
                thinkingText.className = 'thinking-text';

                neurons.forEach(neuron => {
                    neuron.classList.remove('active');
                });
            }

            if (data.stats) {
                document.getElementById('totalRequests').textContent = data.stats.totalRequests || 0;
                document.getElementById('activeRequests').textContent = data.activeRequests || 0;
                document.getElementById('avgResponseTime').textContent = `${data.stats.avgResponseTime || 0}ms`;
            }

            updateActivityFeed(data.recentActivities || []);
        }

        function updateActivityFeed(activities) {
            const feed = document.getElementById('activityFeed');

            if (!activities || activities.length === 0) {
                feed.innerHTML = `
                    <div class="empty-state-teen">
                        <div class="waiting-animation">
                            <div class="bounce-dots">
                                <span></span><span></span><span></span>
                            </div>
                            <div class="waiting-text">Warte auf ALEX Chat-Action... 💬</div>
                        </div>
                    </div>
                `;
                lastActivityIds.clear();
                return;
            }

            const groupedActivities = groupRequestResponse(activities);

            const currentActivityIds = new Set();
            const newActivityIds = new Set();

            groupedActivities.forEach(group => {
                const groupId = group.id || group.activity?.id || `generated_${group.type || 'activity'}_${group.timestamp}`;
                currentActivityIds.add(groupId);

                if (!lastActivityIds.has(groupId)) {
                    newActivityIds.add(groupId);
                }
            });

            console.log('🎨 RENDERING:', {
                total: groupedActivities.length,
                new: newActivityIds.size,
                newIds: Array.from(newActivityIds)
            });

            feed.innerHTML = groupedActivities.map(group => {
                const groupId = group.id || group.activity?.id || `generated_${group.type || 'activity'}_${group.timestamp}`;
                const isNew = newActivityIds.has(groupId);

                let html = '';
                switch(group.type) {
                    case 'conversation':
                        html = renderTeenConversation(group);
                        break;
                    case 'active_thinking':
                        html = renderActiveThinking(group);
                        break;
                    case 'error':
                        html = renderError(group);
                        break;
                    case 'token_redeemed':
                        html = renderTokenRedeemed(group);
                        break;
                    default:
                        return '';
                }

                if (isNew && html) {
                    html = `<div class="activity-flash-container" data-new="true">${html}</div>`;
                }

                return html;
            }).join('');

            lastActivityIds = new Set(currentActivityIds);

            if (newActivityIds.size > 0) {
                triggerFlashAnimations();
            }
        }

        function triggerFlashAnimations() {
            setTimeout(() => {
                const newItems = document.querySelectorAll('.activity-flash-container[data-new="true"]');

                newItems.forEach((item, index) => {
                    setTimeout(() => {
                        item.classList.add('flash-in');

                        setTimeout(() => {
                            item.classList.remove('flash-in');
                            item.removeAttribute('data-new');
                        }, 2000);
                    }, index * 100);
                });
            }, 50);
        }

        function groupRequestResponse(activities) {
            const grouped = [];
            const processed = new Set();

            console.log('🔍 PAIRING DEBUG: Total activities:', activities.length);

            const sortedActivities = activities.sort((a, b) =>
                new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
            );

            sortedActivities.forEach((activity, index) => {
                if (processed.has(activity.id)) return;

                console.log('🔍 Processing:', {
                    type: activity.type,
                    requestId: activity.requestId?.substring(0, 10),
                    message: activity.message?.substring(0, 30)
                });

                if (activity.type === 'request_start') {
                    const matchingResponse = sortedActivities.find(resp =>
                        resp.type === 'request_end' &&
                        resp.requestId === activity.requestId &&
                        resp.requestId &&
                        !processed.has(resp.id)
                    );

                    if (matchingResponse) {
                        console.log('✅ PERFECT PAIR FOUND:', {
                            requestId: activity.requestId?.substring(0, 10),
                            question: activity.message?.substring(0, 30),
                            answer: matchingResponse.response?.substring(0, 30),
                            processingTime: matchingResponse.processingTime
                        });

                        grouped.push({
                            type: 'conversation',
                            id: `conv_${activity.requestId}`,
                            request: activity,
                            response: matchingResponse,
                            responseTime: matchingResponse.processingTime ||
                                calculateResponseTime(activity.timestamp, matchingResponse.timestamp),
                            timestamp: activity.timestamp
                        });

                        processed.add(activity.id);
                        processed.add(matchingResponse.id);

                    } else {
                        console.log('⏳ ACTIVE REQUEST (still thinking):', {
                            requestId: activity.requestId?.substring(0, 10),
                            message: activity.message?.substring(0, 30),
                            age: Math.round((Date.now() - new Date(activity.timestamp).getTime()) / 1000) + 's'
                        });

                        grouped.push({
                            type: 'active_thinking',
                            id: `thinking_${activity.requestId}`,
                            activity: activity,
                            timestamp: activity.timestamp
                        });
                        processed.add(activity.id);
                    }

                } else if (activity.type === 'request_error') {
                    grouped.push({
                        type: 'error',
                        id: `error_${activity.id}`,
                        activity: activity,
                        timestamp: activity.timestamp
                    });
                    processed.add(activity.id);

                } else if (activity.type === 'token_used') {
                    grouped.push({
                        type: 'token_redeemed',
                        id: `token_${activity.id}`,
                        activity: activity,
                        timestamp: activity.timestamp
                    });
                    processed.add(activity.id);
                }
            });

            console.log('🎯 GROUPING RESULT:', {
                total: activities.length,
                conversations: grouped.filter(g => g.type === 'conversation').length,
                thinking: grouped.filter(g => g.type === 'active_thinking').length,
                errors: grouped.filter(g => g.type === 'error').length,
                tokens: grouped.filter(g => g.type === 'token_redeemed').length
            });

            return grouped.sort((a, b) =>
                new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
            );
        }

        function renderTeenConversation(group) {
            const requestTime = new Date(group.request.timestamp).toLocaleTimeString('de-DE', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            const responseTime = new Date(group.response.timestamp).toLocaleTimeString('de-DE', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            const processingTime = group.responseTime;
            const requestMessage = group.request.message || 'Unbekannte Frage';
            const responseMessage = group.response.response || 'Unbekannte Antwort';
            const responsePreview = responseMessage.length > 100 ?
                responseMessage.substring(0, 100) + '...' : responseMessage;

            let speedClass, speedIcon, speedText;
            if (processingTime < 1500) {
                speedClass = 'super-fast';
                speedIcon = '⚡';
                speedText = 'Blitzschnell!';
            } else if (processingTime < 3000) {
                speedClass = 'fast';
                speedIcon = '🚀';
                speedText = 'Schnell';
            } else if (processingTime < 5000) {
                speedClass = 'normal';
                speedIcon = '🔄';
                speedText = 'Normal';
            } else {
                speedClass = 'slow';
                speedIcon = '🐌';
                speedText = 'Langsam';
            }

            const getCharColor = (length) => {
                if (length < 20) return '#7ee787';
                if (length < 100) return '#58a6ff';
                return '#f2cc60';
            };

            return `
                <div class="teen-conversation-card">
                    <div class="conversation-header-teen">
                        <div class="time-flow">
                            <span class="start-time">${requestTime}</span>
                            <div class="processing-flow ${speedClass}">
                                <div class="flow-dots">
                                    <span></span><span></span><span></span>
                                </div>
                                <span class="processing-badge">${speedIcon} ${processingTime}ms</span>
                            </div>
                            <span class="end-time">${responseTime}</span>
                        </div>
                    </div>

                    <div class="chat-bubbles-container">
                        <div class="message-card user-message">
                            <div class="message-header">
                                <span class="avatar">👤</span>
                                <span class="sender-label">User fragt</span>
                                <span class="char-badge" style="background: ${getCharColor(requestMessage.length)}">
                                    ${requestMessage.length} chars
                                </span>
                            </div>
                            <div class="message-content">${requestMessage}</div>
                        </div>

                        <div class="message-flow ${speedClass}">
                            <div class="flow-line"></div>
                            <div class="flow-arrow">▶</div>
                            <div class="flow-time">${processingTime}ms</div>
                            <div class="flow-spark"></div>
                        </div>

                        <div class="message-card alex-message">
                            <div class="message-header">
                                <span class="avatar">🤖</span>
                                <span class="sender-label">ALEX antwortet</span>
                                <span class="char-badge" style="background: ${getCharColor(responseMessage.length)}">
                                    ${responseMessage.length} chars
                                </span>
                            </div>
                            <div class="message-content">${responsePreview}</div>
                        </div>
                    </div>

                    <div class="performance-footer">
                        <div class="speed-indicator ${speedClass}">
                            <div class="speed-bar">
                                <div class="speed-fill" style="width: ${Math.min(100, (7000 - processingTime) / 70)}%"></div>
                            </div>
                            <span class="speed-label">${speedIcon} ${speedText}</span>
                        </div>
                        <div class="conversation-stats">
                            <span class="stat-item">📝 ${requestMessage.length + responseMessage.length} total chars</span>
                            <span class="stat-item">⚡ ${(responseMessage.length / (processingTime / 1000)).toFixed(0)} chars/sec</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderActiveThinking(group) {
            const activity = group.activity;
            const thinkingTime = Math.round((Date.now() - new Date(activity.timestamp).getTime()) / 1000);

            return `
                <div class="thinking-card-teen">
                    <div class="thinking-header">
                        <div class="thinking-dots-big">
                            <span></span><span></span><span></span>
                        </div>
                        <span class="thinking-text">🔥 ALEX denkt krass nach...</span>
                        <span class="thinking-timer">${thinkingTime}s</span>
                    </div>
                    <div class="thinking-question">
                        <span class="question-preview">"${activity.message?.substring(0, 60) || 'Unbekannte Frage'}..."</span>
                    </div>
                </div>
            `;
        }

        function renderTokenRedeemed(group) {
            const activity = group.activity;
            const time = new Date(activity.timestamp).toLocaleTimeString('de-DE');

            return `
                <div class="token-card-teen">
                    <div class="token-header">
                        <span class="token-icon">🎫✨</span>
                        <span class="token-text">Neue Anweisung!</span>
                        <span class="token-time">${time}</span>
                    </div>
                    <div class="token-details">
                        <span class="token-content">${activity.message || 'Neue ALEX-Anweisung'}</span>
                    </div>
                </div>
            `;
        }

        function renderError(group) {
            const activity = group.activity;
            const time = new Date(activity.timestamp).toLocaleTimeString('de-DE');

            return `
                <div class="error-card-teen">
                    <div class="error-header">
                        <span class="error-icon">❌</span>
                        <span class="error-text">Oops! Fehler</span>
                        <span class="error-time">${time}</span>
                    </div>
                    <div class="error-details">
                        ${activity.data?.error || 'Unbekannter Fehler'}
                    </div>
                </div>
            `;
        }

        function calculateResponseTime(startTime, endTime) {
            return new Date(endTime).getTime() - new Date(startTime).getTime();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadBrainState();
            initLiveActivity();
        });

        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
